<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Locating ohlc bars in trading days</title>
    <link rel="stylesheet" href="/css/bt.css">
    <link rel="stylesheet" href="/css/global.css">
    <link rel="stylesheet" href="/css/pygments.css">
</head>
<body>
    <nav class="navbar navbar-default" role="navigation">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Pages</a>
    </div>
    <ul class="nav navbar-nav">
        <li class=""><a href="/languages.html">Languages</a></li>
    </ul>
  </div><!-- /.container-fluid -->
</nav>

    <header>
    
</header>
    <div class="main container">
        <div class="row">
            <div class="col-md-offset-1 col-md-10">
                <div class="row">
    <div class="col-md-12">
        <div class="page-header">
            <h1>Locating ohlc bars in trading days</h1>
        </div>
        <div>
            <p>This example shows how to locate ohlc bars in trading days. For example, how to get all the bars
from current trading day, how to get bars from yesterday by using the <code>today_ohlc</code>, <code>yesterday_ohlc</code> and
the more general <code>ohlc_in_last_days</code> method.</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">ctxalgoctp.ctp.backtesting_utils</span> <span class="kn">import</span> <span class="o">*</span>
</code></pre></div>
<p>The following listing shows a dummy strategy class, and the <code>on_bar</code> method locates ohlc bars in different trading days.</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">DummyStrategy</span><span class="p">(</span><span class="n">AbstractStrategy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A single double moving average trend following strategy:</span>
<span class="sd">    1. If the fast moving average up-cross the slow moving average, change position to 1.</span>
<span class="sd">    2. If the fast moving average down-cross the slow moving average, change position to -1.</span>
<span class="sd">    That is, the position can be 0, -1 and 1.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instrument_ids</span><span class="p">,</span> <span class="n">strategy_period</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">base_folder</span><span class="p">,</span>
                 <span class="n">periods</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">AbstractStrategy</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">instrument_ids</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">base_folder</span><span class="p">,</span> <span class="n">strategy_period</span><span class="o">=</span><span class="n">strategy_period</span><span class="p">,</span>
            <span class="n">periods</span><span class="o">=</span><span class="n">periods</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instrument_id</span><span class="p">,</span> <span class="n">bars</span><span class="p">,</span> <span class="n">tick</span><span class="p">):</span>
        <span class="n">ohlc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ohlc</span><span class="p">()</span>
        <span class="n">today_ohlc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">today_ohlc</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Today bars:</span><span class="se">\t</span><span class="s">{}</span><span class="se">\t</span><span class="s">to</span><span class="se">\t</span><span class="s">{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">today_ohlc</span><span class="o">.</span><span class="n">dates</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">today_ohlc</span><span class="o">.</span><span class="n">dates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

        <span class="c"># Locating the ohlc for yesterday. In the first day of backtesting,</span>
        <span class="c"># we won&#39;t have any bar from yesterday, so we need to check if the result</span>
        <span class="c"># from yesterday_ohlc is None or not.</span>
        <span class="n">yesterday_ohlc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yesterday_ohlc</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">yesterday_ohlc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Yesterday bars:</span><span class="se">\t</span><span class="s">{}</span><span class="se">\t</span><span class="s">to</span><span class="se">\t</span><span class="s">{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">yesterday_ohlc</span><span class="o">.</span><span class="n">dates</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yesterday_ohlc</span><span class="o">.</span><span class="n">dates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

        <span class="c"># # We can ask for ohlc for any day range using bars_in_last_days. Specify start and end</span>
        <span class="c"># # using the same values as you slice a Python array backwards. The difference here</span>
        <span class="c"># # is that the slice unit is in days.</span>
        <span class="c"># # Here we ask for bars from the fourth and third to the last trading days.</span>
        <span class="n">ohlc_in_last_days</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ohlc_in_last_days</span><span class="p">(</span><span class="n">start</span><span class="o">=-</span><span class="mi">4</span><span class="p">,</span> <span class="n">end</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ohlc_in_last_days</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Fourth and third to the last day bars:</span><span class="se">\t</span><span class="s">{}</span><span class="se">\t</span><span class="s">to</span><span class="se">\t</span><span class="s">{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">ohlc_in_last_days</span><span class="o">.</span><span class="n">dates</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ohlc_in_last_days</span><span class="o">.</span><span class="n">dates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</code></pre></div>
<p>Now, we create configurations for backtesting the strategy.</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">start_date</span> <span class="o">=</span> <span class="s">&#39;2014-01-01&#39;</span>  <span class="c"># Backtesting start date.</span>
<span class="n">end_date</span> <span class="o">=</span> <span class="s">&#39;2014-12-31&#39;</span>    <span class="c"># Backtesting end date.</span>

<span class="c"># The values in config will be used to instantiate the strategy objects by the backtest method.</span>
<span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;instrument_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;IF99&#39;</span><span class="p">],</span>                      <span class="c"># We are trading this future instrument.</span>
    <span class="s">&#39;strategy_period&#39;</span><span class="p">:</span> <span class="n">Periodicity</span><span class="o">.</span><span class="n">FIFTEEN_MINUTE</span><span class="p">,</span>   <span class="c"># The ohlc bar granularity on which trading happens.</span>
<span class="p">}</span>

<span class="n">report</span><span class="p">,</span> <span class="n">data_source</span> <span class="o">=</span> <span class="n">backtest</span><span class="p">(</span><span class="n">DummyStrategy</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>
</code></pre></div>
        </div>
    </div>
</div>
<div class="row">
    <div style="margin-top:10px;margin-bottom:10px">
        
        <span class="next">
            上篇：
            <a href="/en/en_e102_multi_time_frames.html">Multi-time frame strategy</a>
        </span>
         
        
        <span class="prev">
            下篇：
            <a href="/en/en_e104_store_information_in_context.html">Persist information in context across trading days</a>
        </span>
        
    </div>
</div>
<div class="row">
    <!-- UY BEGIN -->
    <div id="uyan_frame"></div>
    <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=1959741"></script>
    <!-- UY END -->
</div>
            </div>
        </div>
    </div>
    <footer>
    <hr>
    <div class="container">
        <p align="center">Copyright © ctxalgo.com, build with jekyll. Email me with admin@ctxalgo.com</p>
    </div>
</footer>
    <script type="text/javascript" src="/js/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="/js/bt.js"></script>
</body>
</html>