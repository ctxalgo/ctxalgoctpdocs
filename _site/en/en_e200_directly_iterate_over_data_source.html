<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Iterating over a data source directly</title>
    <link rel="stylesheet" href="/css/bt.css">
    <link rel="stylesheet" href="/css/global.css">
    <link rel="stylesheet" href="/css/pygments.css">
</head>
<body>
    <div class="wrap">
        <nav class="navbar navbar-default" role="navigation">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Pages</a>
    </div>
    <ul class="nav navbar-nav">
        <li class=""><a href="/languages.html">Languages</a></li>
    </ul>
  </div><!-- /.container-fluid -->
</nav>

        <header>
    
</header>
        <div class="main container">
            <div class="row">
                <div class="col-md-offset-1 col-md-10">
                    <div class="row">
    <div class="col-md-12">
        <div class="page-header">
            <h1>Iterating over a data source directly</h1>
        </div>
        <div>
            <p>This example shows how to iterate over data source for backtesting directly, without going through the backtester.
But similar to going over data in the backtester, you can setup the iterator to generate different periods of ohlcs.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">ctxalgolib.ohlc.periodicity</span> <span class="kn">import</span> <span class="n">Periodicity</span>
<span class="kn">from</span> <span class="nn">ctxalgolib.trading_utils.future_info_calculator_factory</span> <span class="kn">import</span> <span class="n">FutureInfoCalculatorFactory</span>
<span class="kn">from</span> <span class="nn">ctxalgoctp.ctp.backtesting_utils</span> <span class="kn">import</span> <span class="n">get_data_source</span>

</pre></td></tr></tbody></table>
</div>
</div>

<h2 id="iterating-over-a-single-instruments-ohlc">Iterating over a single instrument’s ohlc.</h2>

<p>First, we get some historical trading data. The data is downloaded from CTX servers and stored in <code class="highlighter-rouge">base_folder</code>.
You can get the <code class="highlighter-rouge">base_folder</code> to your own folder. Use <code class="highlighter-rouge">instrument_ids</code> to specify the instruments whose data
is to be downloaded. Here, we only specify a single instrument. The historical data time range is decided by
<code class="highlighter-rouge">start_date</code> and <code class="highlighter-rouge">end_date</code>. <code class="highlighter-rouge">data_period</code> specifies the granularity period of the data. It should be smallest
among the periods of the ohlcs that you want your iterator to generate. Here we specify
that we want to download 15 minute bars as historical data.</p>

<p>The historical trading data will be accessible through <code class="highlighter-rouge">data_source</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre><span class="n">instrument_ids</span> <span class="o">=</span> <span class="p">[</span><span class="s">'cu99'</span><span class="p">]</span>
<span class="n">start_date</span> <span class="o">=</span> <span class="s">'2014-01-01'</span>  <span class="c"># Backtesting start date.</span>
<span class="n">end_date</span> <span class="o">=</span> <span class="s">'2014-12-31'</span>    <span class="c"># Backtesting end date.</span>
<span class="n">base_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'CTXALGO_TEST'</span><span class="p">],</span> <span class="s">'strategies'</span><span class="p">,</span> <span class="s">'iterating_data_source'</span><span class="p">)</span>
<span class="n">data_period</span> <span class="o">=</span> <span class="n">Periodicity</span><span class="o">.</span><span class="n">FIFTEEN_MINUTE</span>
<span class="n">data_source</span> <span class="o">=</span> <span class="n">get_data_source</span><span class="p">(</span><span class="n">instrument_ids</span><span class="p">,</span> <span class="n">base_folder</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">data_period</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>Next, we iterate over the historical data. <code class="highlighter-rouge">ohlc_periods</code> specifies the periods of the ohlcs that we want
to iterate over. Here we specify that we want to iterate over two periods of ohlcs, 30 minute bars and daily bars.
These 30 minute and daily bars are generated from the downloaded 15 minute bars.</p>

<p>Then, we call <code class="highlighter-rouge">bars_iterator</code> to get an iterator which yields the required 30 minute and daily bars. The iterator yields
a tuple of three elements (instrument_id, bars, all_ohlcs). <code class="highlighter-rouge">instrument_id</code> tells you whose bars are being returned
this time. <code class="highlighter-rouge">bars' contains the returned bars. </code>all_ohlcs` contains all the ohlcs that are generated so far.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18</pre></td><td class="code"><pre><span class="k">def</span> <span class="nf">iterate_over_data</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">periods</span><span class="p">):</span>
    <span class="s">"""
    Iterate over data_source.
    :param ds: BacktestingDataSource, the data source containing historical trading data.
    :param periods: [Periodicity], the list of periods that the iterator should generate ohlcs for.
    """</span>
    <span class="n">factory</span> <span class="o">=</span> <span class="n">FutureInfoCalculatorFactory</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">instrument_id</span><span class="p">,</span> <span class="n">bars</span><span class="p">,</span> <span class="n">all_ohlcs</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">bars_iterator</span><span class="p">(</span><span class="n">periods</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">period</span><span class="p">,</span> <span class="n">bar</span> <span class="ow">in</span> <span class="n">bars</span><span class="p">[</span><span class="s">'time-based'</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ohlc</span> <span class="o">=</span> <span class="n">all_ohlcs</span><span class="p">[</span><span class="s">'time-based'</span><span class="p">][</span><span class="n">instrument_id</span><span class="p">][</span><span class="n">period</span><span class="p">]</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'instrument={}</span><span class="se">\t</span><span class="s">timestamp={}</span><span class="se">\t</span><span class="s">period={}</span><span class="se">\t</span><span class="s">ohlc_bar_count={}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">instrument_id</span><span class="p">,</span> <span class="n">Periodicity</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="n">period</span><span class="p">),</span> <span class="n">bar</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">ohlc</span><span class="o">.</span><span class="n">length</span><span class="p">))</span>

    <span class="k">print</span><span class="p">(</span><span class="s">''</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">'============ Iterate over single instrument</span><span class="se">\'</span><span class="s">s ohlcs ============'</span><span class="p">)</span>
<span class="n">ohlc_periods</span> <span class="o">=</span> <span class="p">[</span><span class="n">Periodicity</span><span class="o">.</span><span class="n">THIRTY_MINUTE</span><span class="p">,</span> <span class="n">Periodicity</span><span class="o">.</span><span class="n">DAILY</span><span class="p">]</span>
<span class="n">iterate_over_data</span><span class="p">(</span><span class="n">data_source</span><span class="p">,</span> <span class="n">ohlc_periods</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h2 id="iterating-over-multiple-instruments-ohlcs">Iterating over multiple instruments’ ohlcs</h2>

<p>The above code demonstrates how to iterate over a single instrument’s ohlcs. The following code shows how to
iterate over multiple instruments’ ohlcs at the same time. This is useful when designing strategies involving
multiple instruments.</p>

<p>To iterate over multiple instruments, the only change we need is to get data for those instruments. So we
set <code class="highlighter-rouge">instrument_ids</code> to have two instruments. Here we specify two instruments, cu99 and rb99. That’s it.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre><span class="n">instrument_ids</span> <span class="o">=</span> <span class="p">[</span><span class="s">'cu99'</span><span class="p">,</span> <span class="s">'rb99'</span><span class="p">]</span>
<span class="n">data_source2</span> <span class="o">=</span> <span class="n">get_data_source</span><span class="p">(</span><span class="n">instrument_ids</span><span class="p">,</span> <span class="n">base_folder</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">data_period</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">'============ Iterate over two instruments</span><span class="se">\'</span><span class="s"> ohlcs ============'</span><span class="p">)</span>
<span class="n">iterate_over_data</span><span class="p">(</span><span class="n">data_source2</span><span class="p">,</span> <span class="n">ohlc_periods</span><span class="p">)</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h2 id="iterating-over-multiple-bars">Iterating over multiple bars</h2>

<p>If you want to get an event when a set of instruments have all proceeded with a bar,
you can use <code class="highlighter-rouge">multiple_bars_iterator</code>. This method returns an iterator. The iterator yields an element
when all the listed instruments progressed with a bar in the given periods.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre><span class="k">print</span><span class="p">(</span><span class="s">'============ Iterate over multiple bars ============'</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ohlcs</span> <span class="ow">in</span> <span class="n">data_source2</span><span class="o">.</span><span class="n">multiple_bars_iterator</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">Periodicity</span><span class="o">.</span><span class="n">THIRTY_MINUTE</span><span class="p">,</span> <span class="n">instrument_ids</span><span class="o">=</span><span class="p">[</span><span class="s">'cu99'</span><span class="p">,</span> <span class="s">'rb99'</span><span class="p">]):</span>
    <span class="n">ohlc1</span> <span class="o">=</span> <span class="n">ohlcs</span><span class="p">[</span><span class="s">'cu99'</span><span class="p">]</span>
    <span class="n">ohlc2</span> <span class="o">=</span> <span class="n">ohlcs</span><span class="p">[</span><span class="s">'rb99'</span><span class="p">]</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'{} {}: {}</span><span class="se">\t</span><span class="s">{} {}: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">'cu99'</span><span class="p">,</span> <span class="n">ohlc1</span><span class="o">.</span><span class="n">length</span><span class="p">,</span> <span class="n">ohlc1</span><span class="o">.</span><span class="n">dates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s">'rb99'</span><span class="p">,</span> <span class="n">ohlc2</span><span class="o">.</span><span class="n">length</span><span class="p">,</span> <span class="n">ohlc2</span><span class="o">.</span><span class="n">dates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

</pre></td></tr></tbody></table>
</div>
</div>

<h2 id="getting-whole-ohlcs-directly">Getting whole ohlcs directly</h2>

<p>If you want to get the whole ohlcs directly, instead of iterating over an iterator and get the ohlc gradually,
call the <code class="highlighter-rouge">ohlcs</code> method from a data source. The <code class="highlighter-rouge">ohlcs</code> method has the same parameters as the <code class="highlighter-rouge">bars_iterator</code> method,
but it returns the full ohlcs, instead of an iterator.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8</pre></td><td class="code"><pre><span class="k">print</span><span class="p">(</span><span class="s">'============ Get whole ohlcs directly ============'</span><span class="p">)</span>
<span class="n">ohlcs</span> <span class="o">=</span> <span class="n">data_source2</span><span class="o">.</span><span class="n">ohlcs</span><span class="p">(</span><span class="n">ohlc_periods</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'30 minute cu99 ohlc length: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ohlcs</span><span class="p">[</span><span class="s">'time-based'</span><span class="p">][</span><span class="s">'cu99'</span><span class="p">][</span><span class="n">Periodicity</span><span class="o">.</span><span class="n">THIRTY_MINUTE</span><span class="p">]</span><span class="o">.</span><span class="n">length</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">'Daily cu99 ohlc length: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ohlcs</span><span class="p">[</span><span class="s">'time-based'</span><span class="p">][</span><span class="s">'cu99'</span><span class="p">][</span><span class="n">Periodicity</span><span class="o">.</span><span class="n">DAILY</span><span class="p">]</span><span class="o">.</span><span class="n">length</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">'30 minute rb99 ohlc length: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ohlcs</span><span class="p">[</span><span class="s">'time-based'</span><span class="p">][</span><span class="s">'rb99'</span><span class="p">][</span><span class="n">Periodicity</span><span class="o">.</span><span class="n">THIRTY_MINUTE</span><span class="p">]</span><span class="o">.</span><span class="n">length</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">'Daily rb99 ohlc length: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ohlcs</span><span class="p">[</span><span class="s">'time-based'</span><span class="p">][</span><span class="s">'rb99'</span><span class="p">][</span><span class="n">Periodicity</span><span class="o">.</span><span class="n">DAILY</span><span class="p">]</span><span class="o">.</span><span class="n">length</span><span class="p">))</span>


</pre></td></tr></tbody></table>
</div>
</div>

        </div>
    </div>
</div>
<div class="row">
    <div style="margin-top:10px;margin-bottom:10px">
        
        <span class="next">
            上篇：
            <a href="/en/en_e120_statistical_arbitrage_with_two_instruments.html">Statistical arbitrage with two instruments</a>
        </span>
         
        
        <span class="prev">
            下篇：
            <a href="/en/en_e201_plain_backtester.html">Using the plain backtester</a>
        </span>
        
    </div>
</div>
<div class="row">
    <!-- UY BEGIN -->
    <div id="uyan_frame"></div>
    <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=1959741"></script>
    <!-- UY END -->
</div>
<div class="footer-buttom"></div>
                </div>
            </div>
        </div>        
    </div>
    
    <footer class="footer">
    <hr>
    <div class="container">
        <p align="center">Copyright © ctxalgo.com, build with jekyll. Email me with admin@ctxalgo.com</p>
    </div>
</footer>
    <script type="text/javascript" src="/js/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="/js/bt.js"></script>
</body>
</html>