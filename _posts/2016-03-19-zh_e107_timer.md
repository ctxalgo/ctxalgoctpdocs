---
title: 在策略中设置定时器
layout: post
category: root
language: zh
---


本示例展示如何在策略中设置定时器。你可以设置两种定时器：

1. 基于某个时刻的闹钟定时器，该定时器在指定的时刻触发。
2. 倒计时定时器，该定时器会在倒数一段时间后被触发。你可以设置这个定时器为重复的，则它会循环倒数，每次倒数完成都会触发。

在策略中添加一个定时器，你需要调用`add_timer`方法:

```python
    def add_timer(self, timer=None, trigger_time=None, timedelta=None, on_time_action=None, start=True):
```

你可以通过`timer`参数指定一个定时器，也可以通过`trigger_time`来指定一个时刻，从而添加一个闹钟定时器。也可以通过
`timedelta`参数来制定一个时间区间来创建一个循环倒计时定时器。通过`on_time_action`来指定该定时器被触发时的回调函数。
如果没有指定回调函数，则`self.on_timer`会被用作默认的回调函数。每个定时器都会有一个唯一的名字，在回调函数中可以
获得这个名字。


```python
from ctxalgoctp.ctp.backtesting_utils import *


class TimerStrategy(AbstractStrategy):
    def __init__(self, instrument_ids, strategy_period, parameters, base_folder,
                 periods=None, description=None, logger=None):
        AbstractStrategy.__init__(
            self, instrument_ids, parameters, base_folder, strategy_period=strategy_period,
            periods=periods, description=description, logger=logger)

    def on_before_run(self, strategy):
        # Add an alarm timer at 14 clock every trading day.
        self.add_timer(trigger_time=time(14, 0), on_time_action=self.on_14_clock)

    def on_14_clock(self, trigger_time, supposed_trigger_time, timer_name):
        print('Alarm timer triggered at: {}'.format(trigger_time))
        # Add a countdown timer which triggers every 15 minutes.
        self.add_timer(timedelta=timedelta(minutes=15), on_time_action=self.on_every_15_minutes_after_14_clock)

    def on_every_15_minutes_after_14_clock(self, trigger_time, supposed_trigger_time, timer_name):
        print('Countdown timer triggered at: {}'.format(trigger_time))

```

现在，我们来回测该策略。


```python
start_date = '2014-01-01'  # Backtesting start date.
end_date = '2014-12-31'    # Backtesting end date.

# The values in config will be used to instantiate the strategy objects by the backtest method.
config = {
    'instrument_ids': ['IF99'],                      # We are trading this future instrument.
    'strategy_period': Periodicity.FIFTEEN_MINUTE,   # The ohlc bar granularity on which trading happens.
    'parameters': {}
}

report, data_source = backtest(TimerStrategy, config, start_date, end_date)
```

我们能看到命令行中打印出如下信息：

```python
Alarm timer triggered at: 2014-01-02 14:00:00
Countdown timer triggered at: 2014-01-02 14:15:00
Countdown timer triggered at: 2014-01-02 14:30:00
Countdown timer triggered at: 2014-01-02 14:45:00
Countdown timer triggered at: 2014-01-02 15:00:00
Countdown timer triggered at: 2014-01-02 15:15:00
Alarm timer triggered at: 2014-01-03 14:00:00
Countdown timer triggered at: 2014-01-03 14:15:00
Countdown timer triggered at: 2014-01-03 14:30:00
Countdown timer triggered at: 2014-01-03 14:45:00
Countdown timer triggered at: 2014-01-03 15:00:00
Countdown timer triggered at: 2014-01-03 15:15:00
```
